<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ module.name }} – LEAM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/footer.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/toggle_switch.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/module_page.css') }}">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='scripts/module_run.js') }}" defer></script>
    <script src="{{ url_for('static', filename='scripts/module_log_socket.js') }}" defer></script>
    <script src="{{ url_for('static', filename='scripts/module_settings_socket.js') }}" defer></script>
    <script>
        window.LEAM_MODULE = "{{ module_name }}";
    </script>
    {% block head %}{% endblock %}
</head>
<body>

    {% include "components/utilities/header.html" %}

    <main class="module-page">

        <h2>{{ module.name }}</h2>
        <p>{{ module.description }}</p>

        <div class="module-grid">
            <!-- Settings -->
            <section class="panel panel-settings">
                <h3>Settings</h3>
                <form id="settings-form">
                    {% for key, value in module.settings.items() %}
                        {# 1. Parse the key string to extract Name, Type, and Mode #}
                        {% set parts = key.rsplit('-', 1) %}
                        {% set label_raw = parts[0] %}
                        {# Replace underscores with spaces for the label #}
                        {% set label_clean = label_raw.replace('_', ' ') %}
                        
                        {# Get the suffix code (e.g., stringME, integerNS) #}
                        {% set type_code = parts[1] if parts|length > 1 else 'stringNE' %}
                        
                        {# 2. Decode the suffix #}
                        {% set is_long_text = 'stringL' in type_code %}
                        {% set is_static = 'S' in type_code %}
                        {% set is_float = 'integerF' in type_code %}
                        {% set is_number = 'integer' in type_code %}

                        {# 3. Render the Field #}
                        <div class="form-group">
                            <label for="{{ key }}">{{ label_clean }}</label>
                            
                            {% if is_static %}
                                <input 
                                    type="text" 
                                    id="{{ key }}"
                                    name="{{ key }}" 
                                    value="{{ value }}" 
                                    class="input-static"
                                    readonly
                                    title="This value is managed automatically by the system."
                                >

                            {% elif is_long_text %}
                                <textarea 
                                    id="{{ key }}"
                                    name="{{ key }}" 
                                    rows="6"
                                >{{ value }}</textarea>

                            {% elif is_number %}
                                <input 
                                    type="number" 
                                    id="{{ key }}"
                                    name="{{ key }}" 
                                    value="{{ value }}"
                                    {% if is_float %}step="0.01"{% endif %}
                                >

                            {% else %}
                                <input 
                                    type="text" 
                                    id="{{ key }}"
                                    name="{{ key }}" 
                                    value="{{ value }}"
                                >
                            {% endif %}
                        </div>
                    {% endfor %}
                </form>
            </section>
            <!-- Run Options -->
            <section class="panel panel-run">
                <h3>Run Options</h3>
                <div class="run-modes">
                    <span class="toggle-label">Off</span>
                    <label class="switch">
                        <input
                            type="checkbox"
                            id="run-toggle"
                            {% if module.run_options.on %}checked{% endif %}
                        >
                        <span class="slider"></span>
                    </label>
                    <span class="toggle-label">On</span>
                </div>
                <div class="run-modes">
                    <span class="mode-label">Finite</span>
                    <label class="switch">
                        <input
                            type="checkbox"
                            id="run-mode-toggle"
                            {% if module.run_options.mode == "indefinite" %}checked{% endif %}
                        >
                        <span class="slider"></span>
                    </label>
                    <span class="mode-label">Indefinite</span>
                </div>
                <div class="run-options" id="run-options">
                    <label>
                        Runs per day
                        <input type="number" id="runs-per-day" min="1" value="{{ module.run_options.runs_per_day }}">
                    </label>
                    <label>
                        Start time
                        <input type="time" id="start-time" value="{{ module.run_options.start_time }}">
                    </label>
                    <label>
                        End time
                        <input type="time" id="end-time" value="{{ module.run_options.end_time }}">
                    </label>
                </div>
                <button id="save-settings-btn" class="module-btn" style="margin-top: 20px;">Save Settings</button>
                <button id="run-btn">Run {{ module.run_file }}</button>
            </section>
            <!-- Output -->
            <section class="panel panel-output">
                <h3>Output</h3>
                <pre id="output">No output yet</pre>
            </section>
            <!-- Logs -->
            <section class="panel panel-logs">
                <h3>Logs</h3>
                <pre id="logs">Waiting for logs…</pre>
            </section>
        </div>
    </main>
    {% include "components/utilities/footer.html" %}
</body>
</html>